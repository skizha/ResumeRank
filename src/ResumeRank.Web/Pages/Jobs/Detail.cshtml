@page "{id}"
@model ResumeRank.Web.Pages.Jobs.DetailModel
@{
    ViewData["Title"] = Model.Job.Title;
}

<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="/Index">Jobs</a></li>
        <li class="breadcrumb-item active">@Model.Job.Title</li>
    </ol>
</nav>

<div class="job-header">
    <div class="row">
        <div class="col-lg-8">
            <h1 class="job-title">@Model.Job.Title</h1>

            <div class="job-meta">
                <div class="job-meta-item">
                    <span class="job-meta-label">Department</span>
                    <span class="job-meta-value">@Model.Job.Department</span>
                </div>
                <div class="job-meta-item">
                    <span class="job-meta-label">Experience</span>
                    <span class="job-meta-value">@Model.Job.ExperienceLevel</span>
                </div>
                <div class="job-meta-item">
                    <span class="job-meta-label">Location</span>
                    <span class="job-meta-value">@Model.Job.Location</span>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.Job.Description))
            {
                <p class="job-description">@Model.Job.Description</p>
            }
        </div>

        <div class="col-lg-4">
            <div class="skills-section">
                @if (Model.Job.RequiredSkills.Any())
                {
                    <div class="skills-group">
                        <span class="skills-label">Required Skills</span>
                        <div>
                            @foreach (var skill in Model.Job.RequiredSkills)
                            {
                                <span class="skill-tag skill-tag--required">@skill</span>
                            }
                        </div>
                    </div>
                }

                @if (Model.Job.PreferredSkills.Any())
                {
                    <div class="skills-group">
                        <span class="skills-label">Preferred Skills</span>
                        <div>
                            @foreach (var skill in Model.Job.PreferredSkills)
                            {
                                <span class="skill-tag">@skill</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="section-header">
    <div class="section-title">
        <h2>Resumes</h2>
        <span class="section-count">@Model.Resumes.Count uploaded</span>
    </div>
    <div class="btn-group-actions">
        <a asp-page="/Jobs/Upload" asp-route-id="@Model.Job.Id" class="btn btn-primary">Upload Resumes</a>
        @if (Model.Resumes.Count > 0)
        {
            <form method="post" asp-page-handler="Rank" asp-route-id="@Model.Job.Id" class="d-inline">
                <button type="submit" class="btn btn-accent">Rank Resumes</button>
            </form>
        }
    </div>
</div>

@if (Model.Resumes.Count == 0)
{
    <div class="alert-empty">
        No resumes uploaded yet. Upload resumes to get started.
    </div>
}
else
{
    <table class="table-swiss">
        <thead>
            <tr>
                <th>Candidate</th>
                <th>File</th>
                <th>Suitable Roles</th>
                <th>Uploaded</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var resume in Model.Resumes)
            {
                var suitableRoles = Model.ResumeSuitableRoles.GetValueOrDefault(resume.Id, new List<ResumeRank.Web.Models.SuitableRole>());
                <tr>
                    <td class="candidate-name">@resume.CandidateName</td>
                    <td class="file-name">@resume.FileName</td>
                    <td>
                        @if (suitableRoles.Any())
                        {
                            <div class="role-tags">
                                @foreach (var role in suitableRoles.Take(4))
                                {
                                    var tagClass = role.Score >= 8 ? "role-tag--high"
                                                 : role.Score >= 5 ? "role-tag--medium"
                                                 : role.Score > 0 ? "role-tag--low"
                                                 : "";
                                    <span class="role-tag @tagClass">
                                        @role.Role
                                        @if (role.Score > 0)
                                        {
                                            <span class="role-score">@role.Score</span>
                                        }
                                    </span>
                                }
                                @if (suitableRoles.Count > 4)
                                {
                                    var remainingRoles = suitableRoles.Skip(4).ToList();
                                    var popoverContent = string.Join("", remainingRoles.Select(r => {
                                        var cls = r.Score >= 8 ? "role-tag--high" : r.Score >= 5 ? "role-tag--medium" : r.Score > 0 ? "role-tag--low" : "";
                                        var scoreText = r.Score > 0 ? $"<span class='role-score'>{r.Score}</span>" : "";
                                        return $"<span class='role-tag {cls}'>{r.Role}{scoreText}</span>";
                                    }));
                                    <a href="javascript:void(0)" class="more-roles" tabindex="0" role="button"
                                       data-bs-toggle="popover" data-bs-trigger="focus" data-bs-html="true"
                                       data-bs-title="More Roles" data-bs-content="<div class='role-tags'>@popoverContent</div>">
                                        +@(suitableRoles.Count - 4) more
                                    </a>
                                }
                            </div>
                        }
                        else
                        {
                            <span class="text-muted">â€”</span>
                        }
                    </td>
                    <td class="date">@resume.UploadedAt.ToString("MMM d, yyyy")</td>
                    <td>
                        <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Job.Id" asp-route-resumeId="@resume.Id" class="d-inline" onsubmit="return confirm('Delete this resume?');">
                            <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (Model.Rankings.Count > 0)
{
    <div class="rankings-section">
        <hr class="section-divider" />

        <div class="section-header">
            <div class="section-title">
                <h2>Rankings</h2>
                <span class="section-count">@Model.Rankings.Count candidates</span>
            </div>
        </div>

        <table class="table-swiss">
            <thead>
                <tr>
                    <th style="width: 60px;">Rank</th>
                    <th>Candidate</th>
                    <th style="width: 100px;">Overall</th>
                    <th style="width: 100px;">Skills</th>
                    <th style="width: 100px;">Experience</th>
                    <th>Summary</th>
                </tr>
            </thead>
            <tbody>
                @{ var rank = 1; }
                @foreach (var result in Model.Rankings)
                {
                    <tr>
                        <td>
                            <span class="rank-number @(rank <= 3 ? "rank-number--top" : "")">@rank</span>
                        </td>
                        <td class="candidate-name">@result.Resume.CandidateName</td>
                        <td>
                            <span class="score-display">@result.OverallScore</span>
                        </td>
                        <td>
                            <span class="score-secondary">@result.SkillMatchScore</span>
                        </td>
                        <td>
                            <span class="score-secondary">@result.ExperienceMatchScore</span>
                        </td>
                        <td>
                            <span class="summary-text">@result.Summary</span>
                        </td>
                    </tr>
                    rank++;
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });
        });
    </script>
}
